name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  analyze:
    runs-on: windows-latest
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Instalar PSScriptAnalyzer
        run: |
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser

      - name: An√°lisis de c√≥digo
        run: |
          $results = Invoke-ScriptAnalyzer -Path ./src/ -Recurse -Severity Error, Warning
          if ($results) {
            foreach ($result in $results) {
              Write-Host "$( $result.Severity ): $( $result.RuleName ) - $( $result.Message )" -ForegroundColor Yellow
              Write-Host "  Archivo: $( $result.ScriptPath )" -ForegroundColor Gray
              Write-Host "  L√≠nea: $( $result.Line )" -ForegroundColor Gray
            }
            if ($results | Where-Object { $_.Severity -eq 'Error' }) {
              exit 1
            }
          }
          else {
            Write-Host "‚úì No se encontraron problemas" -ForegroundColor Green
          }

      - name: Verificar compatibilidad PS5
        run: |
          $incompatible = Get-ChildItem -Path ./src -Recurse -Filter *.ps*1 |
            Select-String -Pattern '#requires.*-Version.*([6-9]|\d{2,})' |
            Select-Object -ExpandProperty FileName
          if ($incompatible) {
            Write-Error "‚ùå Scripts incompatibles con PS5: $incompatible"
            exit 1
          }
          Write-Host "‚úì Compatible con PowerShell 5.0" -ForegroundColor Green

  test:   # üëà OJO: misma indentaci√≥n que "analyze" y "build"
    runs-on: windows-latest
    needs: analyze
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Instalar Pester
        run: |
          Install-Module -Name Pester -Force -Scope CurrentUser

      - name: Ejecutar pruebas
        run: |
          if (Test-Path ./tests) {
            Invoke-Pester ./tests/ -Output Detailed
          }
          else {
            Write-Host "No hay pruebas configuradas" -ForegroundColor Yellow
          }

  build:
    runs-on: windows-latest
    needs: test
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Crear paquete
        run: |
          New-Item -ItemType Directory -Path ./release -Force | Out-Null
          Copy-Item -Path ./src/* -Destination ./release/ -Recurse -Force

          @'
          @echo off
          powershell -ExecutionPolicy Bypass -File "%~dp0main.ps1"
          pause
          '@ | Out-File -FilePath ./release/run.bat -Encoding ASCII

      - name: Subir artefacto
        uses: actions/upload-artifact@v4
        with:
          name: dztools-package
          path: ./release/