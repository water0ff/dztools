name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

defaults:
  run:
    shell: powershell

jobs:
  analyze:
    runs-on: windows-latest
    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Instalar PSScriptAnalyzer
        run: |
          Set-PSRepository -Name PSGallery -InstallationPolicy Trusted
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser

      - name: Análisis de código
        run: |
          $results = Invoke-ScriptAnalyzer -Path ./src/ -Recurse -Severity @('Error','Warning')
          $errors   = @($results | Where-Object Severity -eq 'Error')
          $warnings = @($results | Where-Object Severity -eq 'Warning')
          Write-Host "Resumen ScriptAnalyzer:" -ForegroundColor Cyan
          Write-Host "  Errors:   $($errors.Count)" -ForegroundColor Cyan
          Write-Host "  Warnings: $($warnings.Count)" -ForegroundColor Cyan
          if ($errors.Count -gt 0) {
            Write-Host "Errores encontrados:" -ForegroundColor Red
            foreach ($e in $errors) {
              Write-Host "Error: $($e.RuleName) - $($e.Message)" -ForegroundColor Red
              Write-Host "  File: $($e.ScriptPath)" -ForegroundColor Gray
              Write-Host "  Line: $($e.Line)" -ForegroundColor Gray
            }
            exit 1
          }
          $warnings | Select-Object -First 25 | ForEach-Object {
            Write-Host "Warning: $($_.RuleName) - $($_.Message)" -ForegroundColor Yellow
            Write-Host "  File: $($_.ScriptPath)" -ForegroundColor Gray
            Write-Host "  Line: $($_.Line)" -ForegroundColor Gray
          }
          Write-Host "[OK] Sin errores de ScriptAnalyzer" -ForegroundColor Green

      - name: Verificar compatibilidad PS5
        run: |
          $incompatible = Get-ChildItem -Path ./src -Recurse -Filter *.ps*1 |
            Select-String -Pattern '#requires.*-Version.*([6-9]|\d{2,})' |
            Select-Object -ExpandProperty FileName
          if ($incompatible) {
            Write-Error "Scripts incompatibles con PS5: $incompatible"
            exit 1
          }
          Write-Host " Compatible con PowerShell 5.0" -ForegroundColor Green

  test:
    runs-on: windows-latest
    needs: analyze
    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Instalar Pester
        run: |
          Set-PSRepository -Name PSGallery -InstallationPolicy Trusted
          Install-Module -Name Pester -Force -Scope CurrentUser -MinimumVersion 5.0

      - name: Ejecutar pruebas
        run: |
          if (Test-Path ./tests) {
            Invoke-Pester -Path ./tests/ -Output Detailed -CI
          }
          else {
            Write-Host "No hay pruebas configuradas" -ForegroundColor Yellow
          }

  build:
    runs-on: windows-latest
    needs: test
    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Crear paquete
        run: |
          New-Item -ItemType Directory -Path ./release -Force | Out-Null
          Copy-Item -Path ./src/* -Destination ./release/ -Recurse -Force

          @'
          @echo off
          powershell -ExecutionPolicy Bypass -File "%~dp0main.ps1"
          pause
          '@ | Out-File -FilePath ./release/run.bat -Encoding ASCII

      - name: Subir artefacto
        uses: actions/upload-artifact@v4
        with:
          name: dztools-package
          path: ./release/
